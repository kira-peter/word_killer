# Design Document: Rhythm Dance Mode

## Overview
节奏舞蹈模式是一种融合打字练习和节奏游戏的新玩法。玩家需要正确输入单词字母，并在恰当的时机按下空格键以获得高分判定。

## Architecture

### Core Components

#### 1. Rhythm Timing System (节奏判定系统)
**职责**: 管理指针摆动、位置计算和判定逻辑

**关键数据结构**:
```go
type RhythmDanceState struct {
    PointerPosition  float64  // 指针当前位置 [0.0, 1.0]
    PointerDirection int      // 摆动方向: 1=右, -1=左
    PointerSpeed     float64  // 摆动速度（每帧移动距离）
    GoldenRatio      float64  // 黄金分割点位置（约 0.618）
    CompletedWords   int      // 已完成单词数
    TotalScore       int      // 总分
}
```

**指针摆动逻辑**:
- 初始速度: 0.01（每帧）
- 加速规则: 每完成 1 个单词，速度增加 0.001
- 范围: [0.0, 1.0]，到达边界时反向

**判定算法**:
```
距离 = |PointerPosition - GoldenRatio|
if 距离 <= 0.05: Perfect (5分)
else if 距离 <= 0.15: Nice (3分)
else if 距离 <= 0.30: OK (1分)
else: Miss (0分)
```

#### 2. Dance Animation System (舞蹈动画系统)
**职责**: 根据判定结果渲染不同的 ASCII 小人动画

**动画帧设计**:
- Idle 动画: 2 帧循环（基础站立姿态）
- Perfect 动画: 跳跃姿态（3 帧播放一次）
- Nice 动画: 摆臂姿态（2 帧播放一次）
- OK 动画: 点头姿态（2 帧播放一次）
- Miss 动画: 摔倒姿态（2 帧播放一次）

**动画状态机**:
```
Idle -> (判定触发) -> 特效动画 -> (1秒后) -> Idle
```

#### 3. Visual Effects System (视觉特效系统)
**职责**: 渲染长条区域、指针、判定文字和特效

**长条区域设计**:
- 宽度: 40 字符
- 黄金分割点: 第 25 个字符位置（40 * 0.618 ≈ 25）
- 颜色渐变: 越靠近黄金分割点颜色越亮（黄色）

**判定特效**:
- Perfect: 黄色边框闪烁 + "PERFECT!!" 文字上浮消退
- Nice: 蓝色边框闪烁 + "Nice!" 文字显示
- OK: 白色边框闪烁 + "OK" 文字显示
- Miss: 红色边框 + "Miss..." 文字显示

## Game Flow

### 初始化流程
1. 加载单词词库（使用现有的 short/medium/long）
2. 随机选择第一个单词
3. 初始化指针位置为 0.5，方向为右
4. 初始化小人为 Idle 动画
5. 启动倒计时（默认 60 秒）

### 游戏循环
```
每帧更新:
  1. 更新指针位置（position += speed * direction）
  2. 检查边界反转
  3. 更新舞蹈动画帧
  4. 更新倒计时
  5. 检查时间到判定

输入处理:
  - 字母键: 添加到输入缓冲区，匹配单词（类似经典模式）
  - 退格键: 删除最后一个字符
  - 空格键:
    * 检查单词是否完全正确
    * 计算指针距离并判定等级
    * 更新分数和统计
    * 触发动画和特效
    * 切换到下一个单词
  - ESC: 暂停/退出
```

### 结束流程
1. 时间耗尽时停止游戏
2. 显示统计结果:
   - 总分
   - 完成单词数
   - Perfect/Nice/OK/Miss 各档次计数
   - 准确率
   - 平均每词用时

## UI Layout

```
┌─────────────────────────────────────────────────┐
│           [舞蹈小人动画区域]                      │
│              o/  \o/  o\                        │
│             /|   /|   |\                        │
│             / \  / \  / \                       │
├─────────────────────────────────────────────────┤
│  单词区域:     节奏条区域:                        │
│  word          ├──────────────┼──────────────┤  │
│  w_o_r_d       │       ◆      │              │  │
│                └──────────────▼──────────────┘  │
│                           (黄金点)               │
│  剩余时间: 45s    分数: 125                      │
│  Perfect: 15  Nice: 8  OK: 3  Miss: 2          │
└─────────────────────────────────────────────────┘
```

## Configuration

新增配置项（config.json）:
```json
{
  "rhythm_dance_duration": 60,     // 游戏时长（秒）
  "rhythm_dance_initial_speed": 0.01  // 指针初始速度
}
```

## Trade-offs & Considerations

### 1. 判定区间设计
**选择**: 使用相对宽松的判定区间（Perfect: ±0.05）
**原因**: 打字完单词后按空格的时机控制已经有难度，太严格会降低游戏体验
**替代方案**: 可配置化判定阈值，让玩家自定义难度

### 2. 难度曲线
**选择**: 线性加速（每完成 1 个单词加速 0.001）
**原因**: 难度持续增长，保持玩家紧张感，避免游戏后期过于简单
**未来改进**: 可考虑非线性曲线（如指数增长）或基于玩家表现动态调整，或设置速度上限

### 3. 动画复杂度
**选择**: 简单的 ASCII 字符动画（2-3 帧）
**原因**: 保持命令行界面的简洁性，减少实现复杂度
**未来改进**: 可增加更多动画帧或使用彩色 ASCII 艺术

### 4. 单词显示方式
**选择**: 一次只显示一个单词
**原因**: 聚焦节奏玩法，避免视觉混乱
**替代方案**: 可显示"即将到来"的下一个单词预览

## Testing Strategy

### Unit Tests
- 指针位置计算和边界检测
- 判定算法准确性（各档次阈值）
- 加速逻辑（完成 N 词后速度变化）

### Integration Tests
- 完整游戏流程（初始化 -> 游戏 -> 结束）
- 输入处理和判定触发
- 动画状态切换

### Manual Tests
- 视觉效果验证（特效是否正确显示）
- 节奏感测试（判定时机是否合理）
- 难度曲线体验（是否过难或过易）
